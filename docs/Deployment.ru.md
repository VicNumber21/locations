# Запуск

Сразу оговорюсь, что каких-то конкретных рекомендаций с числами по конфигурации машин и сети у меня нет.
Ниже изложены мои мысли по поводу возможной масштабируемости сервиса.

К сожалению, у меня на данном этапе не хватает опыта, например, выдать рекомендации по памяти на нодах.
Чтобы прийти к конкретным цифрам, я бы организовал нагрузочное тестирование, оценил бы производительность
решения на типовой конфигурации машин в дата центре или у облачного провайдера.
На основании данных тестирования принимались бы решения, что менять в конфигурации нодов или сети.

С этой оговоркой предлагается следующая конфигурация, состоящая из к уровней выполнения запроса.

## 1. Web прокси

На входе рекомендуется поставить HTTP прокси, например, `nginx`, которая будет выбирать для обработки запроса
один из нодов `api`, находящихся на следующем уровне.
Web прокси будет выступать в роли балансира, распределяя нагрузку по `api` нодам.

Начальная конфигураци балансира на базе `nginx` описана по ссылке: http://nginx.org/en/docs/http/load_balancing.html
Насколько она рабочая из коробки - не могу сказать, нужно тестирование.

## 2. Ферма `api`

Каждый нод фермы `api` - это Docker приложение `api`, собираемое при билде в одноимённой папке.
Для запуска приложения рекомендуется искользовать `compose.yaml` файл (в папке `docker`) с параметрами запуска:
```
docker compose -f docker/compose.yaml up api
```

Возможно имеет смыл использовать имеющийся файл `compose.yaml`, как базовый пример для запуска,
и на его основе написать похожий файл с уточнением параметров нода и сети.

Конфигурировать `api` нод рекомендуется с помощью переменных окружения и/или с помощью переопределения
`application.conf` файла (базовый вариант находится в папке `api/src/main/resources`).

Список возможных настроек (в скобках указаны переменные окружения, которые можно использовать для той же цели):

1. Секция `app`
  - `swaggerUI` (`SWAGGER_UI`) - предоставлять или нет Swagger UI. Если значение `"on"` (по умолчанию), то
                                 Swagger UI включен. Иначе выключен (для повышения читаемости, однако,
                                 рекомендуется использовать значение `"off"`). Регистр значения не имеет.
2. Секция http
  - `host` (`HTTP_HOST`) - доменное имя или IP адрес интерфейса, на котором следует запустить HTTP сервер.
                           По умолчанию используется wildcard интерфейс `0.0.0.0`, что позволяет
                           принимать запросы с любого доступного интерфейса.
  - `port` (`HTTP_PORT`) - порт, который слушает HTTP сервер. По умолчанию `8080`.
3. Секция grpc 
  - `host` (`GRPC_HOST`) - доменное имя или IP адрес, на который следует отсылать gRPC запросы (адрес gRPC прокси).
                           Имя по умолчанию `svc`, является именем хоста сервиса локального запуска,
                           поэтому данный параметр, скорее всего, потребует переопределения.
  - `port` (`GRPC_PORT`) - порт, на который посылаются gRPC запросы. По умолчанию `9090`.

Если при разворачивании не используются сети Docker, необходимо пробросить HTTP порт во внешнюю среду,
чтобы Web прокси с первого уровня могло коммуницировать с `api` нодом.
Это можно сделать, определив переменную окружения `API_PORT` (подразумевается, что используется
предоставляемый `compose.yaml` или решение на его базе)

## 3. gRPC прокси

gRPC прокси выполняет ту же функцию балансира, что и Web прокси, но уже для gRPC соединений.

Так как gRPC в качестве транспорта использует HTTP, можно использовать то же решение, что и для Web прокси,
поменяв только конфигурацию. Например, если используется `nginx`, то пример конфигурации для gRPC прокси
может быть найден по ссылке: https://www.vinsguru.com/grpc-load-balancing-with-nginx/

По сути отличие конфигураций сводится лишь к тому, что для gRPC надо обязательно исползовать `http2` и
необходимо `proxy_pass`, используемый для проксирования http, заменить на `grpc_pass`.

Опять же, следует рассматривать предложенную конфигурацию, как базовую.
Для более точной настройки требуется тестирование.

## 4. Ферма сервиса (`svc`)

Каждый нод фермы `svc` - это Docker приложение `svc`, собираемое при билде в одноимённой папке.
Для запуска приложения рекомендуется искользовать `compose.yaml` файл (в папке `docker`) с параметрами запуска:
```
docker compose -f docker/compose.yaml up svc
```

Возможно имеет смыл использовать имеющийся файл `compose.yaml`, как базовый пример для запуска,
и на его основе написать похожий файл с уточнением параметров нода и сети. Особенно требуется обрать
внимание на зависимость `svc` нода от db нода, имеющуюся в текущем файле. Практически точно в режиме
продакшина требуется изменить эту зависимость или избавиться от неё совсем.

Конфигурировать `svc` нод рекомендуется с помощью переменных окружения и/или с помощью переопределения
`application.conf` файла (базовый вариант находится в папке `svc/src/main/resources`).

Список возможных настроек (в скобках указаны переменные окружения, которые можно использовать для той же цели):

1. Секция grpc 
  - `port` (`GRPC_PORT`) - порт, который слушает gRPC сервер. По умолчанию `9090`.
2. Секция db 
  - `driver` (`DB_DRIVER`) - драйвер базы данных. По умолчанию `"org.postgresql.Driver"`
  - `url` (`DB_URL`) - URL, используемый для соединения с базой данных. По умолчанию `"jdbc:postgresql://db:5432"`.
                       Если не используются сети Docker, требует переопределения.
  - `name` (`DB_NAME`) - имя базы данных, к которой нужно присоединиться. На данный момент переопределение не имеет
                         смысла без переопределения SQL скриптов в папке `svc/src/main/resources/db`.
  - `user`:
    - `login` (`DB_USER`) - имя пользователя базы данных, в которой хранятся данные сервиса.
                            Значение по умолчанию `locator`.
                            На данный момент переопределение не имеет смысла без переопределения SQL
                            скриптов в папке `svc/src/main/resources/db`.
    - `password` (`DB_USER_PASSWORD`) - пароль пользователя базы данных, в которой хранятся данные сервиса.
                                        Значение по умолчанию `locator`.
                                        На данный момент переопределение не имеет смысла без переопределения
                                        SQL скриптов в папке `svc/src/main/resources/db`.
  - `admin`:
    - `login` (`DB_ADMIN`) - имя учётной записи администратора базы данных, в которой создаётся база данных
                             сервиса локаций. По умолчанию `user`. Рекомендуется переопределить.
    - `password` (`DB_ADMIN_PASSWORD`) - пароль от учётной записи администратора базы данных, в которой создаётся
                                         база данных сервиса локаций. По умолчанию `pswd`.
                                         Рекомендуется переопределить.

Если при разворачивании не используются сети Docker, необходимо пробросить gRPC порт во внешнюю среду,
чтобы gRPC прокси с третьего уровня могло коммуницировать с `svc` нодом.
Это можно сделать, определив переменную окружения `SVC_PORT` (подразумевается, что используется
предоставляемый `compose.yaml` или решение на его базе)

## 5. База данных

В качестве базы данных предлагается использовать стандартный Docker-образ `postgres`:
https://hub.docker.com/_/postgres .

Решение тестировалось с использованием `postgres:15.2-alpine3.17`, но какой-то уникальной специфики
именно этой версии не использовалось, так что при необходимости можно использовать более старшие версии
и даже более младшие в пределах 15 без дополнительного тестирования.
Версии до 15 скорее всего тоже подойдут, но тут уже рекомендуется провести тестирование на совместимость.

Изменение базы данных на другую может потребовать изменений в коде `svc`, так как используется
нестандартная особенность `postgres` совмещать создание / изменение данных с их последующей
отправкой запрашивающему в одном запросе (https://www.postgresql.org/docs/current/dml-returning.html).
Данное замечание не означает, что замена базы данных на аналогичную абсолютно не возможно, так как
существует достаточно большое количество вендоров, которые так же используют `RETURNING` для
выборки изменённых записей. Просто к этому процессу стоит подходить с осторожностью.

В качестве примера для запуска базы данных рекомендуется использовать предоставляемый `compose.yaml`,
однако почти точно потребуется его модификация в части параметров тонкой настройки. Тем не менее,
предоставляемый файл вполне можно использовать как базовый для написания нужной концигурации.

Запуск базы производится с помощью команды:
```
docker compose -f docker/compose.yaml up db
```

Имеются следующие переменные окружения, который могут быть полезными для настройки поведения базы данных
(значения по умолчанию можно найти в файле `docker/.env`):

  - `DB_ADMIN` - имя учётной записи администратора базы данных. Должно совпадать с именем, используемым `svc`
                 приложением в тех же целях.
  - `DB_ADMIN_PASSWORD` - пароль от учётной записи администратора базы данных. Должен совпадать с паролем,
                          используемым `svc` приложением в тех же целях.
  - `DB_PATH` - путь к базе данных внутри Docker-контейнера.
  - `DB_VOLUME` - путь к внешнему хранилицу файлов, на которое отображается внутренний путь у базе данных.
                  Требует обязательного переопределения.
  - `DB_PORT` - порт, на который база данных получаем запросы. Используется, чтобы пробрость внутренний порт
                (`5432`) из Docker во внешнюю систему. По умолчанию также имеет значение `5432`.
  - `DB_NAME` - имя базы данных, по умолчанию `"locations"`. На данный момент переопределение не имеет значения
                без изменения SQL-скриптов, используемых `svc`.

Из-за отсутствия конекретной информации в задании предполагается использование одного нода с базой данных.
Однако при необходимости можно рассмотреть другие конфигурации, например:
  - при необходимости посторения глобального сервиса, можно использовать базы данных в нескольких
    дата центрах по всему миру, с настройкой репликации между ними. Это позволяет в разных точках мира
    иметь схожие скорости доступа к данным.
  - если сервис разворачивается для конкретного пользователя без нужды у разных пользователей иметь
    запросы к данныи друг друга, можно под каждого пользователя поднимать свою копию решения, используя
    (в том числе) выделенную базу данных для данного пользователя. Альтернативой может быть объединение
    нескольких небольших пользователей в группы, которые используют одну и ту же базу данных.
  - если есть несимметричные требования к разным видам доступа к данным, можно расмотреть возможность
    повышения скорости обработки информации за счёт увеличения количества реплик. Например, если скорость
    записи некритична, но очень критична скорость чтения, можно сделать одну базу данных, в которую можно
    писать, и много её реплик, предоставляющих лишь возможности для чтения, и распределить данные виды
    нодов баз данных между нодами `svc`.

В любом случае, рекомендуется базу данных размещать близко к нодам `svc`, которые будут её использовать.
